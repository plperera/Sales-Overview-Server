# Sales Management API

## Description

This project is an API for managing sales data, including orders and seller information. It provides endpoints for retrieving and managing orders and sellers, with support for pagination, filtering, and sorting. The API is built using TypeScript, Express, and Prisma ORM, and connects to a PostgreSQL database.

## Technologies Used

- **Back-End:**
  - Node.js
  - Express
  - TypeScript
  - Prisma ORM
- **Database:**
  - PostgreSQL

## Project Structure

- **prisma/**: Contains Prisma-related files for database management.
  - `schema.prisma`: Defines the database schema and models for the application.
  - `migrations/`: Directory containing migration files generated by Prisma.
- **src/**: Main source code directory.
  - **config/**: Configuration files for the application.
    - `database.ts`: Sets up and exports the Prisma Client instance.
    - `envs.ts`: Handles environment variable loading.
  - **controllers/**: Contains the logic for handling API requests.
    - `ordersController.ts`: Handles requests related to orders.
    - `sellersController.ts`: Handles requests related to sellers.
  - **middlewares/**: Contains middleware functions for the application.
    - `validateQueryParams.ts`: Middleware to validate query parameters in requests.
  - **repository/**: Contains data access logic.
    - `ordersRepository.ts`: Handles database operations related to orders.
    - `sellersRepository.ts`: Handles database operations related to sellers.
  - **routes/**: Defines API routes.
    - `ordersRoutes.ts`: Routes related to orders.
    - `sellersRoutes.ts`: Routes related to sellers.
  - **scripts/**: Contains scripts for tasks like seeding the database.
    - `seed.ts`: Script to seed the database with initial data.
  - **services/**: Contains business logic.
    - `ordersService.ts`: Business logic for handling orders.
    - `sellersService.ts`: Business logic for handling sellers.
  - **data/**: Contains JSON files used for seeding the database.
    - `sellers.json`: JSON file containing initial seller data.
    - `orders.json`: JSON file containing initial order data.
  - **app.ts**: Main Express application setup.
  - **server.ts**: Entry point to start the Express server.

## API Endpoints

### Orders Endpoints

- **GET /orders/all**
  - Retrieves all orders in the database.

- **GET /orders/pagination**
  - Retrieves paginated orders with optional filtering by seller, country, and sorting options.

  #### Query Parameters:
  
  - `page` (optional): The page number to retrieve. Defaults to 1.
  - `pageSize` (optional): The number of orders per page. Defaults to 10.
  - `sellerId` (optional): Filter orders by a specific seller ID.
  - `country` (optional): Filter orders by country. Acceptable values: `BRA`, `ARG`, `MEX`.
  - `orderBy` (optional): Sort orders by a specific column and direction. Format: `column-DIRECTION`, where:
    - `column`: The column to sort by. Acceptable values: `orderId`, `product`, `price`, `seller`, `country`.
    - `DIRECTION`: The direction of sorting. Acceptable values: `ASC` (ascending), `DESC` (descending).
  
  #### Example Request:
  ```bash
  GET /orders/pagination?page=2&pageSize=5&sellerId=1&country=BRA&orderBy=price-DESC
  ```
  
  #### Example Response:
  ```json
  {
    "first": 1,
    "prev": 1,
    "next": 3,
    "lastPage": 4,
    "totalItems": 20,
    "ordersData": [
      {
        "orderId": 12,
        "product": "Smartphone",
        "price": 1500,
        "seller": "John Doe",
        "sellerId": 1,
        "country": "BRA"
      },
      {
        "orderId": 13,
        "product": "Laptop",
        "price": 2500,
        "seller": "John Doe",
        "sellerId": 1,
        "country": "BRA"
      },
      ...
    ]
  }
  ```
  
  #### Response Details:
  
  - `first`: The first page number available (always 1).
  - `prev`: The previous page number, or `null` if on the first page.
  - `next`: The next page number, or `null` if on the last page.
  - `lastPage`: The last page number available based on the total items and `pageSize`.
  - `totalItems`: The total number of orders that match the filters.
  - `ordersData`: An array of order objects, each containing:
    - `orderId`: The unique identifier of the order.
    - `product`: The name of the product ordered.
    - `price`: The price of the order (in the smallest currency unit).
    - `seller`: The name of the seller associated with the order.
    - `sellerId`: The unique identifier of the seller.
    - `country`: The country associated with the order.

- **GET /orders/unique/:orderId**
  - Retrieves a specific order by its ID.

### Sellers Endpoints

- **GET /sellers/all**
  - Retrieves all sellers in the database.

- **GET /sellers/top**
  - Retrieves the top sellers based on sales value.

  #### Response Details:

  This endpoint returns the top 3 sellers based on the total sales value of their orders. The response includes the total sales amount, the number of orders, and basic information about the seller.

  #### Example Response:
  ```json
  [
    {
      "totalSales": 50000,
      "sales": 10,
      "sellerId": 1,
      "sellerName": "John Doe"
    },
    {
      "totalSales": 45000,
      "sales": 8,
      "sellerId": 2,
      "sellerName": "Jane Smith"
    },
    {
      "totalSales": 30000,
      "sales": 5,
      "sellerId": 3,
      "sellerName": "Carlos Mendez"
    }
  ]
  ```
  
  - `totalSales`: The total sales value generated by the seller (in the smallest currency unit).
  - `sales`: The number of orders associated with the seller.
  - `sellerId`: The unique identifier of the seller.
  - `sellerName`: The name of the seller.

- **GET /sellers/unique/:sellerId**
  - Retrieves detailed information about a specific seller, including their sales data.

  #### URL Parameters:
  
  - `sellerId`: The unique identifier of the seller whose details are to be retrieved.
  
  #### Response Details:
  
  This endpoint returns detailed information about the specified seller, including their total sales value, number of orders, sales distribution by country, and top-selling products.

  #### Example Response:
  ```json
  {
    "name": "John Doe",
    "totalSales": 50000,
    "totalValue": 250000,
    "salesByCountry": [
      {
        "name": "BRA",
        "amount": 150000,
        "color": "#36A0DD"
      },
      {
        "name": "ARG",
        "amount": 50000,
        "color": "#9452FF"
      },
      {
        "name": "MEX",
        "amount": 50000,
        "color": "#DD36AB"
      }
    ],
    "topProducts": [
      {
        "name": "Smartphone",
        "sales": 5
      },
      {
        "name": "Laptop",
        "sales": 3
      },
      {
        "name": "Tablet",
        "sales": 2
      }
    ]
  }
  ```
  
  - `name`: The name of the seller.
  - `totalSales`: The total number of orders associated with the seller.
  - `totalValue`: The total sales value generated by the seller (in the smallest currency unit).
  - `salesByCountry`: An array showing the distribution of sales by country:
    - `name`: The country code (e.g., `BRA`, `ARG`, `MEX`).
    - `amount`: The total sales value for that country.
    - `color`: A color associated with the country (used for graphical representation).
  - `topProducts`: An array showing the top-selling products for the seller:
    - `name`: The name of the product.
    - `sales`: The number of units sold.

## Seeding the Database

### JSON Files for Seeding

The seed script populates the database with initial data using two JSON files:

- **sellers.json**: Contains the initial data for sellers.
- **orders.json**: Contains the initial data for orders.

These files are located in the `src/data/` directory. You can modify these files to change the initial data that gets populated into the database. 

#### sellers.json

This file defines the sellers that will be inserted into the database. Each seller must have a unique `id` and a `name`.

Example `sellers.json`:
```json
[
  {
    "id": 1,
    "name": "John Doe"
  },
  {
    "id": 2,
    "name": "Jane Smith"
  },
  {
    "id": 3,
    "name": "Carlos Mendez"
  }
]
```

**Rules:**
- `id`: Must be a unique integer.
- `name`: Must be a non-empty string.

#### orders.json

This file defines the orders that will be inserted into the database. Each order must have a unique `orderId`, a `product` name, a `seller` ID (which must match an existing seller), a `country` code, and a `price`.

Example `orders.json`:
```json
[
  {
    "orderId": 1,
    "product": "Smartphone",
    "seller": 1,
    "country": "BRA",
    "price": 1500.00
  },
  {
    "orderId": 2,
    "product": "Laptop",
    "seller": 1,
    "country": "ARG",
    "price": 2500.00
  },
  {
    "orderId": 3,
    "product": "Tablet",
    "seller": 2,
    "country": "MEX",
    "price": 800.00
  }
]
```

**Rules:**
- `orderId`: Must be a unique integer.
- `product`: Must be a non-empty string.
- `seller`: Must be an integer that corresponds to an existing seller ID in the `sellers.json` file.
- `country`: Must be one of the predefined values (`BRA`, `ARG`, `MEX`).
- `price`: Must be a positive number. The script multiplies the price by 100 before saving to the database to store it as an integer (in the smallest currency unit).

### Seeding the Database

To seed the database with the data defined in these JSON files, run the following command:

```bash
npm run seed
```

This will delete all existing data in the `orders` and `sellers` tables and insert the data from the `sellers.json` and `orders.json` files.

## Installation and Setup

### Prerequisites

- Node.js v14 or higher
- npm
- PostgreSQL

### PostgreSQL Setup

1. **Install PostgreSQL:**
   Make sure PostgreSQL is installed on your system. You can download and install it from [the official PostgreSQL website](https://www.postgresql.org/download/).

2. **Create a Database:**
   Create a new database for the API to connect to. You can do this by accessing the PostgreSQL command-line tool or using a GUI like pgAdmin.
   
   Example command to create a database:
   ```sql
   CREATE DATABASE api_webapp;
   ```

3. **Set Up User and Password:**
   Ensure that you have a PostgreSQL user with the appropriate permissions to access the database. The default user is usually `postgres`.

   Example command to create a user and set a password:
   ```sql
   CREATE USER postgres WITH PASSWORD '123';
   ```

### Environment Setup

1. **Clone the repository:**
   ```bash
   git clone https://github.com/plperera/development-test-rtb-house.git
   cd development-test-rtb-house
   ```

2. **Install dependencies:**
   ```bash
   npm install
   ```

3. **Environment Configuration:**
   Rename the `.env.example` file to `.env` and update it with your PostgreSQL database connection details:
   ```bash
   DATABASE_URL=postgresql://postgres:123@localhost:5432/api_webapp?schema=public
   PORT=4000
   ```
   - `DATABASE_URL`: Connection string for your PostgreSQL database.
   - `PORT`: Port on which the API server will run.

4. **Run database migrations:**
   Apply the database schema to your PostgreSQL database using Prisma:
   ```bash
   npm run migration:generate
   npm run migration:run
   ```

5. **Seed the database:**
   Populate the database with initial data using the seed script:
   ```bash
   npm run seed
   ```

6. **Start the application:**
   Start the development server:
   ```bash
   npm start
   ```

   The server will run on `http://localhost:4000` by default.

## Build Process

### Building the Application for Production

To build the application for production, follow these steps:

1. **Create the Production Build:**
   Run the following command to compile the TypeScript code into JavaScript:
   ```bash
   npm run build
   ```
   This will generate the compiled files in the `dist/` directory.

2. **Start the Production Server:**
   After building the project, you can start the production server:
   ```bash
   npm run prod
   ```

### Summary

By following these steps, you can set up, develop, and deploy the Sales Management API. The API is designed to be scalable, maintainable, and easy to extend with additional features.

## Author

- **Pedro Leoncio** - [GitHub](https://github.com/plperera)
